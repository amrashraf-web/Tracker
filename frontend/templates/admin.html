{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Admin Dashboard</h2>
</div>

<!-- Tabs for different sections -->
<div class="card mb-4">
    <div class="card-body">
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tracking-tab" data-bs-toggle="tab" data-bs-target="#tracking"
                    type="button" role="tab">
                    <i class="fas fa-envelope me-2"></i>All Emails
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button"
                    role="tab">
                    <i class="fas fa-users me-2"></i>Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="danger-tab" data-bs-toggle="tab" data-bs-target="#danger" type="button"
                    role="tab">
                    <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                </button>
            </li>
        </ul>
    </div>
</div>

<div class="tab-content" id="adminTabContent">
    <!-- Email Tracking Tab -->
    <div class="tab-pane fade show active" id="tracking" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Tracked Emails</h5>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Search by email address...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary" onclick="searchTracking()">Search</button>
                        <button class="btn btn-outline-secondary ms-2" onclick="clearSearch()">Clear</button>
                        <button class="btn btn-info ms-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Tracking Data Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Sent By</th>
                                <th>Recipient Email</th>
                                <th>Subject</th>
                                <th>Opens</th>
                                <th>Clicks</th>
                                <th>Last Open</th>
                                <th>Last IP</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trackingTableBody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Tracking pagination">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Users Management Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">User Management</h5>
                <button class="btn btn-primary btn-sm" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <!-- Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Users</h6>
                                <h3 id="totalUsers">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Admin Users</h6>
                                <h3 id="totalAdmins">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Danger Zone Tab -->
    <div class="tab-pane fade" id="danger" role="tabpanel">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger" role="alert">
                    <strong>Warning!</strong> These actions cannot be undone.
                </div>

                <div class="card border-danger">
                    <div class="card-body">
                        <h5 class="card-title">Clear All Tracking Data</h5>
                        <p class="card-text">Delete all email tracking, opens, and clicks from the database.</p>
                        <button class="btn btn-danger" onclick="confirmClearDatabase()">
                            <i class="fas fa-trash-alt me-1"></i>Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clear Database Confirmation Modal -->
<div class="modal fade" id="clearDatabaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Clear All Database
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to delete all tracking data? This will remove:</p>
                <ul>
                    <li>All email tracking records</li>
                    <li>All open events</li>
                    <li>All click events</li>
                </ul>
                <p><strong>Type "DELETE ALL" to confirm:</strong></p>
                <input type="text" class="form-control" id="confirmDeleteInput" placeholder="Type DELETE ALL">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearDatabase()" id="confirmDeleteBtn" disabled>
                    <i class="fas fa-trash-alt me-1"></i>Delete All Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tracking Details Modal -->
<div class="modal fade" id="trackingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Tracking Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="trackingDetailsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check if user is admin on page load
    async function checkAdminAccess() {
        try {
            const response = await fetch('/api/me');
            if (!response.ok) {
                window.location.href = '/login';
                return;
            }

            const data = await response.json();
            if (!data.user.is_admin) {
                window.location.href = '/dashboard';
                return;
            }

            // Load initial data
            loadTracking();
            refreshUsers();
        } catch (error) {
            console.error('Admin check error:', error);
            window.location.href = '/login';
        }
    }

    // Load tracking data
    async function loadTracking(page = 1, search = '') {
        try {
            const url = new URL('/api/tracking', window.location.origin);
            url.searchParams.append('page', page);
            if (search) url.searchParams.append('search', search);

            const response = await fetch(url);
            const data = await response.json();

            if (data.success) {
                displayTracking(data.data);
                displayPagination(data.current_page, data.pages, search);
            }
        } catch (error) {
            console.error('Error loading tracking:', error);
            showToast('Error loading tracking data', 'danger');
        }
    }

    // Display tracking data
    function displayTracking(items) {
        const tbody = document.getElementById('trackingTableBody');

        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No tracking data found</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(item => `
        <tr>
            <td><small><span class="badge bg-info">${item.id}</span></small></td>
            <td>${escapeHtml(item.recipient_email)}</td>
            <td>${escapeHtml(item.subject || 'No subject')}</td>
            <td><span class="badge bg-success">${item.open_count}</span></td>
            <td><span class="badge bg-warning">${item.click_count}</span></td>
            <td><small>${formatDate(item.last_open_time) || 'Never'}</small></td>
            <td><small>${item.last_ip || 'N/A'}</small></td>
            <td><small>${formatDate(item.created_at)}</small></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewTrackingDetails('${item.tracking_id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
    }

    // Load users
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();

            if (data.success) {
                displayUsers(data.users);
            }
        } catch (error) {
            console.error('Error loading users:', error);
            showToast('Error loading users', 'danger');
        }
    }

    // Display users
    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        const adminCount = users.filter(u => u.is_admin).length;

        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('totalAdmins').textContent = adminCount;

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users found</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(user => `
        <tr>
            <td><strong>${escapeHtml(user.username)}</strong></td>
            <td>${escapeHtml(user.email)}</td>
            <td>
                <span class="badge ${user.is_admin ? 'bg-danger' : 'bg-secondary'}">
                    ${user.is_admin ? 'Admin' : 'User'}
                </span>
            </td>
            <td><small>${formatDate(user.created_at)}</small></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="toggleAdmin(${user.id})">
                    ${user.is_admin ? 'Remove Admin' : 'Make Admin'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                    Delete
                </button>
            </td>
        </tr>
    `).join('');
    }

    // Toggle admin status
    async function toggleAdmin(userId) {
        if (!confirm('Toggle admin status?')) return;

        try {
            const response = await fetch('/api/admin/users/' + userId + '/toggle-admin', {
                method: 'POST'
            });

            const data = await response.json();
            if (data.success) {
                showToast('Admin status updated', 'success');
                refreshUsers();
            } else {
                showToast(data.message || 'Error', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error: ' + error.message, 'danger');
        }
    }

    // Delete user
    async function deleteUser(userId) {
        if (!confirm('Delete this user? This cannot be undone!')) return;

        try {
            const response = await fetch('/api/admin/users/' + userId, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                showToast('User deleted', 'success');
                refreshUsers();
            } else {
                showToast(data.message || 'Error', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error: ' + error.message, 'danger');
        }
    }

    // View tracking details
    async function viewTrackingDetails(trackingId) {
        try {
            const response = await fetch('/api/tracking/' + trackingId + '/details');
            const data = await response.json();

            if (data.success) {
                const tracking = data.tracking;
                const opens = data.opens || [];
                const clicks = data.clicks || [];

                let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Recipient:</strong> ${escapeHtml(tracking.recipient_email)}</p>
                        <p><strong>Subject:</strong> ${escapeHtml(tracking.subject || 'No subject')}</p>
                        <p><strong>Tracking ID:</strong> <code>${tracking.tracking_id}</code></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total Opens:</strong> ${tracking.open_count}</p>
                        <p><strong>Total Clicks:</strong> ${tracking.click_count}</p>
                        <p><strong>Sent:</strong> ${formatDate(tracking.created_at)}</p>
                    </div>
                </div>

                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="opens-tab" data-bs-toggle="tab" data-bs-target="#opens" type="button" role="tab">
                            Opens (${opens.length})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="clicks-tab" data-bs-toggle="tab" data-bs-target="#clicks" type="button" role="tab">
                            Clicks (${clicks.length})
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="opens" role="tabpanel">
                        ${opens.length === 0 ? '<p class="mt-3">No opens yet</p>' : `
                            <table class="table table-sm mt-3">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>IP</th>
                                        <th>Port</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${opens.map(o => `
                                        <tr>
                                            <td>${formatDate(o.open_time)}</td>
                                            <td><code>${o.ip}</code></td>
                                            <td><code>${o.port}</code></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                    <div class="tab-pane fade" id="clicks" role="tabpanel">
                        ${clicks.length === 0 ? '<p class="mt-3">No clicks yet</p>' : `
                            <table class="table table-sm mt-3">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>IP</th>
                                        <th>Port</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${clicks.map(c => `
                                        <tr>
                                            <td>${formatDate(c.click_time)}</td>
                                            <td><code>${c.ip}</code></td>
                                            <td><code>${c.port}</code></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;

                document.getElementById('trackingDetailsContent').innerHTML = html;
                new bootstrap.Modal(document.getElementById('trackingDetailsModal')).show();
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error loading details', 'danger');
        }
    }

    // Search tracking
    function searchTracking() {
        const search = document.getElementById('searchInput').value;
        loadTracking(1, search);
    }

    // Clear search
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        loadTracking(1, '');
    }

    // Refresh data
    function refreshData() {
        const search = document.getElementById('searchInput').value;
        loadTracking(1, search);
    }

    // Refresh users
    function refreshUsers() {
        loadUsers();
    }

    // Display pagination
    function displayPagination(currentPage, totalPages, search = '') {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (i === currentPage ? ' active' : '');
            li.innerHTML = `<button class="page-link" onclick="loadTracking(${i}, '${search}')">${i}</button>`;
            pagination.appendChild(li);
        }
    }

    // Confirm clear database
    function confirmClearDatabase() {
        new bootstrap.Modal(document.getElementById('clearDatabaseModal')).show();

        // Enable button only when correct text is typed
        document.getElementById('confirmDeleteInput').addEventListener('input', function () {
            document.getElementById('confirmDeleteBtn').disabled = this.value !== 'DELETE ALL';
        });
    }

    // Clear database
    async function clearDatabase() {
        try {
            const response = await fetch('/api/admin/clear-database', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirmation: 'DELETE ALL' })
            });

            const data = await response.json();
            if (data.success) {
                showToast('All data deleted', 'success');
                bootstrap.Modal.getInstance(document.getElementById('clearDatabaseModal')).hide();
                refreshData();
            } else {
                showToast(data.message || 'Error', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error: ' + error.message, 'danger');
        }
    }

    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const body = document.getElementById('toast-body');

        toast.className = 'toast show';
        body.textContent = message;
        body.className = `toast-body bg-${type} text-white`;

        setTimeout(() => {
            toast.className = 'toast';
        }, 3000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', checkAdminAccess);
</script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}